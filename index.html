<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Suna-Sapo: Winter Edition Fix</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 1.2s ease, visibility 1.2s; }
        #loader-logo-container { width: 240px; height: 240px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        #loader-logo-img { max-width: 100%; max-height: 100%; box-shadow: none; object-fit: contain; opacity: 0; transition: opacity 0.8s ease; }
        .dot-pulse { display: flex; align-items: center; justify-content: center; }
        .dot-pulse div { width: 14px; height: 14px; margin: 0 10px; background-color: #00fbff; border-radius: 50%; animation: dot-pulse 1.4s infinite ease-in-out both; }
        @keyframes dot-pulse { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1.2); opacity: 1; } }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: white; font-family: sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        #time-display { font-size: 24px; font-weight: bold; }
        .mt-controls { position: absolute; top: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .mt-btn { width: 44px; height: 44px; background: white; border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; background-repeat: no-repeat; background-position: center; }
        .log-toggle-btn { background-image: url('https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png'); background-size: 40px; }
        .shelter-toggle-btn { background-image: url('https://raw.githubusercontent.com/sapporo-geolab/hinanzyo-img/main/hinanzyo.png'); background-size: 32px; background-color: white; transition: background-color 0.3s; }
        .active-shelter { background-color: #4cd964 !important; }
        .mapboxgl-ctrl-geolocate { display: none !important; }
        #log-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 20000; backdrop-filter: blur(5px); }
        .modal-content { background: rgba(255, 255, 255, 0.95); width: 340px; max-height: 70vh; border-radius: 15px; overflow: hidden; box-shadow: 0 15px 40px rgba(0,0,0,0.6); font-family: sans-serif; }
        .modal-header { padding: 18px; background: #f8f9fa; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; }
        .close-modal { cursor: pointer; font-size: 24px; color: #666; }
        .pop-btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; font-size: 14px; }
        .report-btn-red { background: #ff3b30 !important; color: white !important; }
        .report-btn-disabled { background: #cccccc; color: #ffffff; cursor: not-allowed; }
        .done-btn-green { background: #4cd964; color: white; }
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .shelter-beam-container { display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .shelter-beam { width: 4px; height: 180px; background: linear-gradient(to top, rgba(76, 217, 100, 0.9), rgba(76, 217, 100, 0)); box-shadow: 0 0 12px rgba(76, 217, 100, 0.8); transform-origin: bottom; position: absolute; bottom: 0px; animation: beam-flicker 2s infinite alternate ease-in-out; }
        @keyframes beam-flicker { from { opacity: 0.6; transform: scaleY(1); } to { opacity: 1; transform: scaleY(1.3); } }
        .shelter-logo-icon { width: 52px; height: 52px; margin-bottom: 180px; background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.9)); pointer-events: auto; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader">
    <div id="loader-logo-container">
        <img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunahako-img/main/logo_sunasapo.png" alt="" onload="this.style.opacity='1'">
    </div>
    <div class="dot-pulse"><div></div><div></div><div></div></div>
    <div id="status-text" style="margin-top:20px; color:#666; font-family:sans-serif; font-size:12px;">ÁèæÂú®Âú∞„ÇíÁâπÂÆö‰∏≠...</div>
</div>

<div id="map"></div>

<div id="log-modal"><div class="modal-content"><div class="modal-header"><span>üì¢ Á†ÇÂàá„ÇåÂ†±Âëä„É™„Çπ„Éà</span><span class="close-modal" onclick="closeLog()">‚úï</span></div><div id="log-list" style="padding:15px; overflow-y:auto; max-height:55vh;"><div style="text-align:center; color:#999;">ÁèæÂú®„ÄÅÂ†±Âëä„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div></div></div></div>
<canvas id="snow-canvas"></canvas>
<div class="info-panel"><div id="date-display">----Âπ¥--Êúà--Êó•(-)</div><div id="time-display">00:00:00</div></div>
<div class="mt-controls">
    <button class="mt-btn log-toggle-btn" onclick="openLog()"></button>
    <button id="shelter-btn" class="mt-btn shelter-toggle-btn" onclick="toggleShelters()"></button>
    <button class="mt-btn" onclick="jumpToCurrentLocation()"><svg viewBox="0 0 24 24" width="24" height="24" fill="#333"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg></button>
    <button class="mt-btn" onclick="map.zoomIn()"><svg viewBox="0 0 24 24" width="24" height="24" fill="#333"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
    <button class="mt-btn" onclick="map.zoomOut()"><svg viewBox="0 0 24 24" width="24" height="24" fill="#333"><path d="M19 13H5v-2h14v2z"/></svg></button>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCiSrqwXpRYYYfjkhtLo2lePrN1rjPaPiY",
      authDomain: "suna-sapo-3d.firebaseapp.com",
      projectId: "suna-sapo-3d",
      storageBucket: "suna-sapo-3d.firebasestorage.app",
      messagingSenderId: "618496872034",
      appId: "1:618496872034:web:050fef3a74fa2af0b88b3b",
      databaseURL: "https://suna-sapo-3d-default-rtdb.firebaseio.com" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let rawData = [];
    let sandboxData = { type: 'FeatureCollection', features: [] };
    let reportLog = [];
    let shelterMarkers = [];
    let sheltersVisible = false;
    let isTracking = false; 
    let initialGPSLocked = false;
    let lastCoords = null;

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rbm4yOXE5MDdwNDNkczh5MnlqNnI4eCJ9.Utenu-9vEz56uGUETeWS1g';
    const map = new mapboxgl.Map({ 
        container: 'map', 
        style: 'mapbox://styles/mapbox/standard', 
        center: [141.3508, 43.0645], 
        zoom: 17, pitch: 65, bearing: -10, attributionControl: false 
    });

    // „Çπ„Çø„Ç§„É´ÊÉÖÂ†±„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„ÅüÁû¨Èñì„Å´Ë®≠ÂÆö„ÇíÊµÅ„ÅóËæº„ÇÄ
    map.on('style.import.load', () => {
        map.setConfigProperty('basemap', 'snowIntensity', 1.0);
        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
    });

    const userMarkerEl = document.createElement('div');
    userMarkerEl.style.width = '20px'; userMarkerEl.style.height = '20px';
    userMarkerEl.style.background = '#007cff'; userMarkerEl.style.border = '3px solid white';
    userMarkerEl.style.borderRadius = '50%'; userMarkerEl.style.boxShadow = '0 0 15px rgba(0,124,255,0.8)';
    const userMarker = new mapboxgl.Marker(userMarkerEl).setLngLat([0, 0]).addTo(map);

    function handleOrientation(event) {
        if (!isTracking) return;
        let heading = event.webkitCompassHeading || (360 - event.alpha);
        if (heading) map.setBearing(heading); 
    }

    navigator.geolocation.watchPosition((pos) => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;
        const accuracy = pos.coords.accuracy;
        lastCoords = [lng, lat];
        userMarker.setLngLat(lastCoords);
        if (!initialGPSLocked && accuracy < 80) {
            initialGPSLocked = true;
            document.getElementById('status-text').textContent = "ÁèæÂú®Âú∞„ÇíÊçïÊçâÔºÅ";
            map.jumpTo({ center: lastCoords });
        }
        if (isTracking) map.setCenter(lastCoords);
    }, (err) => { initialGPSLocked = true; }, { enableHighAccuracy: true });

    function jumpToCurrentLocation() {
        if (!lastCoords) return;
        isTracking = true;
        window.addEventListener('deviceorientation', handleOrientation);
        map.flyTo({ center: lastCoords, zoom: 18.5, pitch: 70, speed: 1.5 });
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission().catch(console.error);
        }
    }

    map.on('dragstart', () => { isTracking = false; window.removeEventListener('deviceorientation', handleOrientation); });

    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    function updateSnow() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const pitch = map.getPitch(); 
        const is3D = pitch > 25;
        if (particles.length < 160) {
            particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2.5 + 0.5, o: Math.random() * 0.4 + 0.2, vx: (Math.random() - 0.5) * 0.8, vy: Math.random() * 1.2 + 0.8 });
        }
        for (let i = 0; i < particles.length; i++) {
            let p = particles[i];
            let fadeOut = 1;
            if (p.y > canvas.height * 0.8) fadeOut = 1 - (p.y - canvas.height * 0.8) / (canvas.height * 0.2);
            ctx.beginPath();
            ctx.fillStyle = `rgba(255, 255, 255, ${p.o * fadeOut})`;
            if (!is3D) {
                const scale = 1 - (p.y / canvas.height)
