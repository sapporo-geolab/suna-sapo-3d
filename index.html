<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Suna-Sapo: Clear 3D Snow</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 1.2s ease, visibility 1.2s; }
        #loader-logo-container { width: 240px; height: 240px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        #loader-logo-img { max-width: 100%; max-height: 100%; box-shadow: none; object-fit: contain; opacity: 0; transition: opacity 0.8s ease; }
        .dot-pulse { display: flex; align-items: center; justify-content: center; }
        .dot-pulse div { width: 14px; height: 14px; margin: 0 10px; background-color: #00fbff; border-radius: 50%; animation: dot-pulse 1.4s infinite ease-in-out both; }
        @keyframes dot-pulse { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1.2); opacity: 1; } }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: white; font-family: sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        #time-display { font-size: 24px; font-weight: bold; }
        .mt-controls { position: absolute; top: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .mt-btn { width: 44px; height: 44px; background: white; border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; background-repeat: no-repeat; background-position: center; }
        .log-toggle-btn { background-image: url('https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png'); background-size: 40px; }
        .shelter-toggle-btn { background-image: url('https://raw.githubusercontent.com/sapporo-geolab/hinanzyo-img/main/hinanzyo.png'); background-size: 32px; background-color: white; transition: background-color 0.3s; }
        .active-shelter { background-color: #4cd964 !important; }
        .mapboxgl-ctrl-geolocate { display: none !important; }
        
        #log-modal, #info-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 20000; backdrop-filter: blur(5px); }
        
        /* ã‚¤ãƒ³ãƒ•ã‚©ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-content { background: rgba(30, 30, 30, 0.95); width: 340px; max-height: 90vh; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.6); font-family: sans-serif; position: relative; border: 1px solid #444; color: #eee; overflow-y: auto; }
        .info-content { padding: 20px; font-size: 12px; line-height: 1.5; }
        .info-content h3 { font-size: 16px; margin: 0 0 12px 0; border-bottom: 1px solid #444; padding-bottom: 8px; color: #fff; text-align: left; }
        .info-content a { color: #00fbff; text-decoration: none; font-weight: normal; } /* ç´°å­—ã®é’ */
        .info-content p { margin: 10px 0; }
        .info-content b { color: #fff; font-weight: bold; } /* å¤ªå­—ã®ç™½ */
        .close-btn-round { background: transparent; color: #888; border: none; width: 28px; height: 28px; cursor: pointer; float: right; font-size: 20px; font-weight: bold; line-height: 1; transition: color 0.2s; }
        .close-btn-round:hover { color: #fff; }

        .modal-header { padding: 18px; background: #f8f9fa; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; border-radius: 15px 15px 0 0; color: #333; }
        .close-modal { cursor: pointer; font-size: 24px; color: #666; }
        .log-modal-content { background: white; width: 340px; border-radius: 15px; }
        
        .pop-btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; font-size: 14px; }
        .report-btn-red { background: #ff3b30 !important; color: white !important; }
        .report-btn-disabled { background: #cccccc; color: #ffffff; cursor: not-allowed; }
        .done-btn-green { background: #4cd964; color: white; }
        
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .shelter-beam-container { display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .shelter-beam { width: 4px; height: 180px; background: linear-gradient(to top, rgba(76, 217, 100, 0.9), rgba(76, 217, 100, 0)); box-shadow: 0 0 12px rgba(76, 217, 100, 0.8); transform-origin: bottom; position: absolute; bottom: 0px; animation: beam-flicker 2s infinite alternate ease-in-out; }
        @keyframes beam-flicker { from { opacity: 0.6; transform: scaleY(1); } to { opacity: 1; transform: scaleY(1.3); } }
        .shelter-logo-icon { width: 52px; height: 52px; margin-bottom: 180px; background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.9)); pointer-events: auto; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader">
    <div id="loader-logo-container">
        <img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunahako-img/main/logo_sunasapo.png" alt="" onload="this.style.opacity='1'">
    </div>
    <div class="dot-pulse"><div></div><div></div><div></div></div>
    <div id="status-text" style="margin-top:20px; color:#666; font-family:sans-serif; font-size:12px;">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
</div>

<div id="map"></div>

<div id="log-modal"><div class="modal-content log-modal-content"><div class="modal-header"><span>ğŸ“¢ ç ‚åˆ‡ã‚Œå ±å‘Šãƒªã‚¹ãƒˆ</span><span class="close-modal" onclick="closeLog()">âœ•</span></div><div id="log-list" style="padding:15px; overflow-y:auto; max-height:55vh;"><div style="text-align:center; color:#999;">ç¾åœ¨ã€å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</div></div></div></div>

<div id="info-modal">
    <div class="modal-content info-content">
        <button class="close-btn-round" onclick="closeInfo()">âœ•</button>
        <h3>ã™ãªã‚µãƒ ã«ã¤ã„ã¦</h3>
        
        <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ <a href="https://github.com/sapporo-geolab" target="_blank">å²¡æœ¬ å“ä¹Ÿ</a> ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸã€‚</p>
        <p>æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨ã™ã‚‹ç ‚ç®±ãŠã‚ˆã³é¿é›£æ‰€ã®ä½ç½®æƒ…å ±ãƒ‡ãƒ¼ã‚¿ã¯ã€æœ­å¹Œå¸‚ICTæ´»ç”¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€Œ<a href="https://data.pf-sapporo.jp/" target="_blank">DATA-SMART CITY SAPPORO</a>ã€ã«ãŠã„ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
        
        <p style="margin-top:15px;"><b>ğŸ’¡ ã¤ã‹ã„ã‹ãŸ</b></p>
        <p style="margin-bottom:4px;">ãƒ»<b>ç ‚åˆ‡ã‚Œã‚’æ•™ãˆã‚‹</b>: åœ°å›³ä¸Šã®ç ‚ç®±ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <p style="margin-bottom:4px;">ãƒ»<b>çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹</b>: å³ä¸Šã®ç ‚ç®±ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨å ±å‘Šã•ã‚Œã¦ã„ã‚‹ç ‚åˆ‡ã‚Œãƒªã‚¹ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
        <p style="margin-bottom:4px;">ãƒ»<b>é¿é›£æ‰€ã‚’è¦‹ã‚‹</b>: å³å´ã®é¿é›£æ‰€ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ã€å¸‚å†…ã®é¿é›£æ‰€ãŒå…‰ã®æŸ±ã¨ã¨ã‚‚ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        <p style="margin-bottom:4px;">ãƒ»<b>ç¾åœ¨åœ°ã¸è¡Œã</b>: å³å´ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚¯ã‚’æŠ¼ã™ã¨ã€ã‚ãªãŸã®ä»Šã„ã‚‹å ´æ‰€ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚</p>

        <p style="margin-top:15px;">ç ‚ç®±ãƒ‡ãƒ¼ã‚¿ã¯å¹³æˆ30å¹´æ™‚ç‚¹ã®ã‚‚ã®ã§ã‚ã‚Šã€ç¾åœ°ã®çŠ¶æ³ã¨å¿…ãšã—ã‚‚ä¸€è‡´ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        <p>æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºå†…å®¹ã‚„ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã€æœ­å¹Œå¸‚ãŠã‚ˆã³é–¢é€£äº‹æ¥­è€…ã¸ã®ç›´æ¥ã®å•ã„åˆã‚ã›ã¯è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚</p>
        <p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ <a href="https://github.com/sapporo-geolab" target="_blank">GitHub ãƒªãƒã‚¸ãƒˆãƒª</a> ã«ã¦å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        
        <p style="font-size: 11px; color: #888; text-align: center; margin-top: 15px; border-top: 1px solid #444; padding-top: 10px;">Â©2026 Takuya Okamoto</p>
    </div>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCiSrqwXpRYYYfjkhtLo2lePrN1rjPaPiY",
      authDomain: "suna-sapo-3d.firebaseapp.com",
      projectId: "suna-sapo-3d",
      storageBucket: "suna-sapo-3d.firebasestorage.app",
      messagingSenderId: "618496872034",
      appId: "1:618496872034:web:050fef3a74fa2af0b88b3b",
      databaseURL: "https://suna-sapo-3d-default-rtdb.firebaseio.com" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let rawData = [];
    let reportLog = [];
    let sandboxData = { type: 'FeatureCollection', features: [] };
    let shelterMarkers = [];
    let sheltersVisible = false;
    let isTracking = false; 
    let initialGPSLocked = false;
    let lastCoords = null;
    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rbm4yOXE5MDdwNDNkczh5MnlqNnI4eCJ9.Utenu-9vEz56uGUETeWS1g';
    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/standard', center: [141.3508, 43.0645], zoom: 17, pitch: 65, bearing: -10, attributionControl: false });
    const userMarkerEl = document.createElement('div');
    userMarkerEl.style.width = '20px'; userMarkerEl.style.height = '20px';
    userMarkerEl.style.background = '#007cff'; userMarkerEl.style.border = '3px solid white';
    userMarkerEl.style.borderRadius = '50%'; userMarkerEl.style.boxShadow = '0 0 15px rgba(0,124,255,0.8)';
    const userMarker = new mapboxgl.Marker(userMarkerEl).setLngLat([0, 0]).addTo(map);
    function handleOrientation(event) { if (!isTracking) return; let heading = event.webkitCompassHeading || (360 - event.alpha); if (heading) map.setBearing(heading); }
    navigator.geolocation.watchPosition((pos) => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;
        const accuracy = pos.coords.accuracy;
        lastCoords = [lng, lat];
        userMarker.setLngLat(lastCoords);
        if (!initialGPSLocked && accuracy < 80) { initialGPSLocked = true; document.getElementById('status-text').textContent = "ç¾åœ¨åœ°ã‚’å–å¾—ï¼"; map.jumpTo({ center: lastCoords }); }
        if (isTracking) map.setCenter(lastCoords);
    }, (err) => { initialGPSLocked = true; }, { enableHighAccuracy: true });
    function jumpToCurrentLocation() {
        if (!lastCoords) return;
        isTracking = true;
        window.addEventListener('deviceorientation', handleOrientation);
        map.flyTo({ center: lastCoords, zoom: 18.5, pitch: 70, speed: 1.5 });
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DeviceOrientationEvent.requestPermission().catch(console.error); }
    }
    map.on('dragstart', () => { isTracking = false; window.removeEventListener('deviceorientation', handleOrientation); });
    function openLog() { document.getElementById('log-modal').style.display = 'flex'; }
    function closeLog() { document.getElementById('log-modal').style.display = 'none'; }
    function openInfo() { document.getElementById('info-modal').style.display = 'flex'; }
    function closeInfo() { document.getElementById('info-modal').style.display = 'none'; }
    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    function updateSnow() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const pitch = map.getPitch(); 
        const is3D = pitch > 25;
        if (particles.length < 160) {
            particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2.5 + 0.5, o: Math.random() * 0.4 + 0.2, vx: (Math.random() - 0.5) * 0.8, vy: Math.random() * 1.2 + 0.8 });
        }
        for (let i = 0; i < particles.length; i++) {
            let p = particles[i];
            let fadeOut = 1;
            if (p.y > canvas.height * 0.8) fadeOut = 1 - (p.y - canvas.height * 0.8) / (canvas.height * 0.2);
            ctx.beginPath();
            ctx.fillStyle = `rgba(255, 255, 255, ${p.o * fadeOut})`;
            if (!is3D) {
                const scale = 1 - (p.y / canvas.height) * 0.5;
                ctx.arc(p.x, p.y, p.r * scale, 0, Math.PI * 2);
                p.y += p.vy;
            } else {
                const perspective = (p.y / canvas.height);
                const speed = p.vy * (1 + perspective * 1.2);
                const xShift = (p.x - canvas.width / 2) * (perspective * 0.06);
                let displayRadius = Math.min(p.r * (1 + perspective * 1.5), 4);
                ctx.arc(p.x + xShift, p.y, displayRadius, 0, Math.PI * 2);
                p.y += speed; p.x += p.vx + xShift * 0.01;
            }
            if (p.y > canvas.height || p.x < -50 || p.x > canvas.width + 50 || fadeOut <= 0) { p.y = -20; p.x = Math.random() * canvas.width; }
            ctx.fill();
        }
        requestAnimationFrame(updateSnow);
    }
    
    function applyGlowingEffect() {
        if (!map.isStyleLoaded()) return;
        const now = new Date();
        const hour = now.getHours();
        const min = now.getMinutes();
        const currentTime = hour + min / 60;
        
        let preset;
        let emissiveStrength = 0;

        if (currentTime >= 6 && currentTime < 15) {
            preset = 'day';
            emissiveStrength = 0; 
        } else if (currentTime >= 15 && currentTime < 16.5) {
            preset = 'dusk';
            emissiveStrength = 0.6;
        } else {
            preset = 'night';
            emissiveStrength = 0.9;
        }

        map.setConfigProperty('basemap', 'lightPreset', preset);
        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
        
        if (map.getLayer('sunabako-layer')) {
            map.setPaintProperty('sunabako-layer', 'fill-extrusion-emissive-strength', emissiveStrength);
        }
    }
    
    function hideLoader() {
        const checkGPS = setInterval(() => {
            if (initialGPSLocked) { clearInterval(checkGPS); setTimeout(() => { document.getElementById('loader').style.opacity = '0'; setTimeout(() => { document.getElementById('loader').style.visibility = 'hidden'; }, 1200); }, 800); }
        }, 500);
    }
    async function loadAndRunGraphics() {
        const gistUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ef76bf0034584f3c6ee30d7489f7f427/raw/graphics.js?t=' + Date.now();
        try {
            const response = await fetch(gistUrl);
            const drawFunc = new Function('map', 'rawData', 'sandboxData', (await response.text()) + '\nupdateSandboxGraphics(map, rawData, sandboxData);');
            drawFunc(map, rawData, sandboxData);
            applyGlowingEffect();
            hideLoader();
        } catch (e) { hideLoader(); }
    }
    map.on('load', () => {
        const csvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ca0f9f45e8a5e2064678f14eb8e7e933/raw/33abeeab3374bc93c97d208c90056b7355c04802/h301.csv';
        Papa.parse(csvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: async function(results) {
                rawData = results.data;
                db.ref('reports').on('value', (snapshot) => {
                    const reports = snapshot.val() || {};
                    rawData.forEach((item, idx) => { item.isGray = !!reports[idx]; });
                    reportLog = Object.keys(reports).map(id => ({ id: id, address: rawData[id]['ä½æ‰€'], time: reports[id].timeLabel })).reverse();
                    updateLogPanel(); loadAndRunGraphics(); 
                });
                map.addSource('sunabako-source', { 'type': 'geojson', 'data': sandboxData });
                map.addLayer({ 
                    'id': 'sunabako-layer', 'type': 'fill-extrusion', 'source': 'sunabako-source', 'slot': 'top', 
                    'paint': { 
                        'fill-extrusion-color': ['get', 'color'], 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-base': ['get', 'base'], 'fill-extrusion-vertical-gradient': true,
                        'fill-extrusion-emissive-strength': 0.6
                    } 
                });
                map.addLayer({ 'id': 'sunabako-click-area', 'type': 'circle', 'source': 'sunabako-source', 'slot': 'top', 'paint': { 'circle-radius': 12, 'circle-color': 'rgba(0,0,0,0)', 'circle-stroke-width': 0 } });
                updateSnow(); loadShelters();
            }
        });
        setInterval(() => {
            document.getElementById('date-display').textContent = `${new Date().getFullYear()}å¹´${new Date().getMonth()+1}æœˆ${new Date().getDate()}æ—¥`;
            document.getElementById('time-display').textContent = new Date().toLocaleTimeString('ja-JP', {hour12:false});
            applyGlowingEffect();
        }, 1000);
    });
    map.on('zoomend', loadAndRunGraphics);
    function toggleShelters() { sheltersVisible = !sheltersVisible; shelterMarkers.forEach(m => { if (sheltersVisible) m.addTo(map); else m.remove(); }); document.getElementById('shelter-btn').classList.toggle('active-shelter', sheltersVisible); }
    function loadShelters() {
        const shelterCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/439bfe19b1a67005f9ca196dc8de7749/raw/55a5b8e97eab134fae8d880d05daa40c916971b4/shelters.csv';
        const shelterIconUrl = 'https://raw.githubusercontent.com/sapporo-geolab/hinanzyo-img/main/hinanzyo.png';
        Papa.parse(shelterCsvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach(row => {
                    const lon = parseFloat(row['çµŒåº¦']); const lat = parseFloat(row['ç·¯åº¦']);
                    if (!isNaN(lon) && !isNaN(lat)) {
                        const container = document.createElement('div'); container.className = 'shelter-beam-container';
                        const beam = document.createElement('div'); beam.className = 'shelter-beam';
                        const iconMark = document.createElement('div'); iconMark.className = 'shelter-logo-icon'; iconMark.style.backgroundImage = `url('${shelterIconUrl}')`;
                        container.appendChild(beam); container.appendChild(iconMark);
                        const marker = new mapboxgl.Marker(container).setLngLat([lon, lat]).setPopup(new mapboxgl.Popup().setHTML(`<div style="color:#333; padding:5px; font-family:sans-serif;"><b>${row['æ–½è¨­å'] || row['é¿é›£æ‰€å']}</b></div>`));
                        shelterMarkers.push(marker); if (sheltersVisible) marker.addTo(map);
                    }
                });
            }
        });
    }
    window.reportEmpty = function(id) { db.ref('reports/' + id).set({ time: Date.now(), timeLabel: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) }); const popup = document.querySelector('.mapboxgl-popup'); if (popup) popup.remove(); };
    window.markAsDone = function(logIdx) { const id = reportLog[logIdx] ? reportLog[logIdx].id : logIdx; db.ref('reports/' + id).remove(); const popup = document.querySelector('.mapboxgl-popup'); if (popup) popup.remove(); };
    function updateLogPanel() {
        const list = document.getElementById('log-list'); if (reportLog.length === 0) { list.innerHTML = '<div style="text-align:center; color:#999; font-size:12px;">ç¾åœ¨ã€å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
        list.innerHTML = reportLog.map((log, i) => `
            <div style="border-bottom:1px solid #eee; padding:8px 0; display:flex; justify-content:space-between; align-items:center;">
                <div onclick="closeLog(); map.flyTo({center:[${rawData[log.id]['çµŒåº¦ï¼ˆåº¦ï¼‰']}, ${rawData[log.id]['ç·¯åº¦ï¼ˆåº¦ï¼‰']}], zoom:18.5})" style="cursor:pointer;"><div style="color:#ff3b30; font-size:10px;">ç¢ºèªï¼š${log.time}</div><div style="font-weight:bold; font-size:12px;">${log.address.replace('åŒ—æµ·é“æœ­å¹Œå¸‚', '')}</div></div>
                <button onclick="markAsDone(${i})" style="background:#4cd964; color:white; border:none; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:bold; cursor:pointer;">è£œå……æ¸ˆ</button>
            </div>`).join('');
    }
    map.on('click', 'sunabako-click-area', (e) => {
        const p = e.features[0].properties;
        if (p.id !== undefined) {
            const isGray = rawData[p.id].isGray;
            new mapboxgl.Popup({ maxWidth: '280px', focusAfterOpen: true, anchor: 'center' }).setLngLat(e.lngLat).setHTML(`<div style="font-family: sans-serif; width: 220px; color: #333;"><img src="https://raw.githubusercontent.com/sapporo-geolab/suna-img/main/suna.jpg" style="width:100%; border-radius:8px;"><p style="margin: 10px 0 5px; font-size:14px;"><strong>${rawData[p.id]['ä½æ‰€']}</strong></p>${isGray ? `<div style="color: #ff3b30; font-size: 11px; font-weight: bold; margin-bottom: 5px;">ç¾åœ¨ã€ç ‚åˆ‡ã‚Œå ±å‘ŠãŒå‡ºã¦ã„ã¾ã™</div><button class="pop-btn report-btn-disabled" disabled>ç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹</button><button class="pop-btn done-btn-green" onclick="markAsDone(${p.id})">è£œå……ã•ã‚Œã¾ã—ãŸ</button>` : `<button class="pop-btn pop-btn report-btn-red" onclick="reportEmpty(${p.id})">ç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹</button>`}</div>`).addTo(map);
        }
    });
</script>
</body>
</html>
