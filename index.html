<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>ã™ãªã‚µãƒ</title>
    <link rel="icon" href="https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png" type="image/png">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 1.2s ease, visibility 1.2s; }
        #loader-logo-container { width: 240px; height: 240px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        #loader-logo-img { max-width: 100%; max-height: 100%; box-shadow: none; object-fit: contain; opacity: 0; transition: opacity 0.8s ease; }
        .dot-pulse { display: flex; align-items: center; justify-content: center; }
        .dot-pulse div { width: 14px; height: 14px; margin: 0 10px; background-color: #00fbff; border-radius: 50%; animation: dot-pulse 1.4s infinite ease-in-out both; }
        @keyframes dot-pulse { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1.2); opacity: 1; } }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: white; font-family: sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        #time-display { font-size: 24px; font-weight: bold; }
        .mt-controls { position: absolute; top: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .mt-btn { width: 44px; height: 44px; background: white; border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; background-repeat: no-repeat; background-position: center; }
        .log-toggle-btn { background-image: url('https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png'); background-size: 40px; }
        .road-report-btn-yahoo { position: absolute; bottom: 75px; left: 15px; z-index: 1000; background: white; color: #1e88e5; border: none; padding: 10px 20px; border-radius: 24px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: sans-serif; transition: transform 0.1s; }
        .road-report-btn-yahoo:active { transform: scale(0.95); }
        #road-legend { position: absolute; bottom: 145px; left: 15px; z-index: 1000; background: rgba(40, 40, 40, 0.85); padding: 8px 12px; border-radius: 10px; color: white; font-family: sans-serif; font-size: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: none; display: flex; flex-direction: column; gap: 4px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .road-icon { width: 32px; height: 32px; border-radius: 50%; background-size: cover; background-position: center; box-shadow: 0 2px 8px rgba(0,0,0,0.4); cursor: pointer; }
        .road-icon-comment { border: 3px solid white; width: 36px; height: 36px; }
        #layer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 25000; }
        .layer-panel { background: rgba(30, 30, 30, 0.95); width: 280px; border-radius: 12px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-family: sans-serif; color: white; position: relative; }
        .layer-title { font-size: 16px; margin-bottom: 15px; font-weight: bold; text-align: center; }
        .layer-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; border: 2px solid transparent; }
        .layer-item:hover { background: rgba(255,255,255,0.1); }
        .layer-item.active { border-color: #007cff; background: rgba(0,124,255,0.15); }
        .layer-icon-box { width: 32px; height: 32px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        .layer-label { font-size: 14px; flex-grow: 1; }
        #log-modal, #info-modal, #road-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 20000; backdrop-filter: blur(5px); }
        .modal-content { background: rgba(255, 255, 255, 0.95); width: 340px; max-height: 80vh; border-radius: 15px; overflow-y: auto; box-shadow: 0 15px 40px rgba(0,0,0,0.6); font-family: sans-serif; position: relative; }
        .info-content { background: rgba(30, 30, 30, 0.95); color: #eee; line-height: 1.5; padding: 20px; font-size: 13px; }
        .info-content h3 { font-size: 16px; margin: 0 0 12px 0; border-bottom: 1px solid #444; padding-bottom: 8px; color: #fff; }
        .info-content a { color: #00fbff; text-decoration: none; font-weight: bold; }
        .info-content p { margin: 10px 0; }
        .info-content b { color: #fff; font-weight: bold; }
        .close-btn-round { position: sticky; top: 0; right: 0; background: #444; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; float: right; font-weight: bold; z-index: 10; }
        .log-modal-content { background: white !important; width: 340px; border-radius: 15px; }
        .modal-header { padding: 18px; background: #f8f9fa; font-weight: bold; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 10; }
        .close-modal { cursor: pointer; font-size: 24px; color: #666; }
        .pop-btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; font-size: 14px; }
        .report-btn-red { background: #ff3b30 !important; color: white !important; }
        .spread-btn-blue { background: #007cff !important; color: white !important; }
        .report-btn-disabled { background: #cccccc !important; color: #ffffff !important; cursor: not-allowed; }
        .done-btn-green { background: #4cd964; color: white; }
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .shelter-beam-container { display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .shelter-beam { width: 4px; height: 180px; background: linear-gradient(to top, rgba(76, 217, 100, 0.9), rgba(76, 217, 100, 0)); box-shadow: 0 0 12px rgba(76, 217, 100, 0.8); transform-origin: bottom; position: absolute; bottom: 0px; animation: beam-flicker 2s infinite alternate ease-in-out; }
        @keyframes beam-flicker { from { opacity: 0.6; transform: scaleY(1); } to { opacity: 1; transform: scaleY(1.3); } }
        .shelter-logo-icon { width: 52px; height: 52px; margin-bottom: 180px; background-size: contain; background-repeat: no-repeat; background-position: center; filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.9)); pointer-events: auto; cursor: pointer; }

        /* è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š */
        #rule-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 30000; }
        .rule-content { background: white; width: 310px; max-height: 75vh; padding: 25px 20px; border-radius: 15px; color: #333; position: relative; overflow-y: auto; font-size: 13px; line-height: 1.6; font-family: sans-serif; }
        .info-icon-small { cursor: pointer; color: #1e88e5; font-size: 18px; vertical-align: middle; margin-left: 8px; }
        .close-rule-btn { position: absolute; top: 10px; right: 10px; font-size: 28px; font-weight: bold; color: #999; cursor: pointer; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; }
        .rule-section-title { font-weight: bold; margin-top: 15px; display: block; }

        /* --- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ç”¨è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« --- */
        .hover-video-popup .mapboxgl-popup-content {
            background: rgba(26, 26, 26, 0.9);
            color: #fff;
            padding: 0;
            border-radius: 8px;
            overflow: hidden;
            width: 180px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
        .hover-video-title { font-size: 10px; padding: 4px 8px; background: rgba(0,0,0,0.5); text-align: center; }
        .live-camera-main-popup {
            position: fixed !important;
            top: auto !important;
            bottom: 30px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            width: 95% !important;
            max-width: 500px !important;
            z-index: 21000 !important; /* æ—¢å­˜UIã‚ˆã‚Šæ‰‹å‰ã« */
        }
        .live-camera-main-popup .mapboxgl-popup-tip { display: none !important; }
        .live-camera-main-popup .mapboxgl-popup-content {
            background: #1a1a1a;
            color: #fff;
            border-radius: 12px !important; /* è§’ä¸¸ã‚’é©ç”¨ */
            padding: 0;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0,0,0,0.6);
        }
        .live-camera-main-popup .mapboxgl-popup-content iframe { border-bottom-left-radius: 12px !important; border-bottom-right-radius: 12px !important; }
        .live-camera-main-popup .mapboxgl-popup-close-button { color: #fff; font-size: 24px; padding: 10px; z-index: 11; }
        .popup-header-cam { padding: 10px 15px; font-weight: bold; font-size: 14px; background: #2a2a2a; }
    </style>
    <link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="app_logo.png">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker registered', reg))
        .catch(err => console.error('Service Worker registration failed', err));
    });
  }
</script>
</head>
<body>

<div id="loader">
    <div id="loader-logo-container">
        <img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunahako-img/main/logo_sunasapo.png" alt="" onload="this.style.opacity='1'">
    </div>
    <div class="dot-pulse"><div></div><div></div><div></div></div>
    <div id="status-text" style="margin-top:20px; color:#666; font-family:sans-serif; font-size:12px;">ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...</div>
</div>

<div id="map"></div>
<div id="road-legend">
    <div class="legend-item"><div class="legend-dot" style="background:#ff3b30;"></div>éå¸¸ã«æ»‘ã‚Šã‚„ã™ã„</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ffcc00;"></div>æ»‘ã‚Šã‚„ã™ã„</div>
    <div class="legend-item"><div class="legend-dot" style="background:#007aff;"></div>ã‚ã¾ã‚Šæ»‘ã‚‰ãªã„</div>
    <div class="legend-item" style="margin-top:2px; border-top:1px solid #555; padding-top:2px; opacity:0.8;">â€»ç™½æ ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚Š</div>
</div>
<button class="road-report-btn-yahoo" onclick="openRoadReport()"><span style="font-size: 18px;">ğŸ’¬</span> æŠ•ç¨¿ã™ã‚‹</button>
<div id="log-modal"><div class="modal-content log-modal-content"><div class="modal-header"><span>ğŸ“¢ ç ‚åˆ‡ã‚Œå ±å‘Šãƒªã‚¹ãƒˆ</span><span class="close-modal" onclick="closeLog()">âœ•</span></div><div id="log-list" style="padding:15px; overflow-y:auto; max-height:55vh;"><div style="text-align:center; color:#999;">ç¾åœ¨ã€å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</div></div></div></div>

<div id="road-modal">
    <div class="modal-content" style="background: white; width: 320px; padding: 20px; border-radius: 15px; color: #333;">
        <h3 style="margin-top:0; font-size:18px; display: flex; align-items: center;">
            é“è·¯ã®çŠ¶æ³ã‚’æ•™ãˆã¦
            <span class="info-icon-small" onclick="openRule()">â“˜</span>
        </h3>
        <p style="font-size:12px; margin-bottom:5px; font-weight:bold;">é“è·¯ã®æ»‘ã‚Šå…·åˆã¯ï¼Ÿï¼ˆå¿…é ˆï¼‰</p>
        <select id="road-level" style="width:100%; padding:12px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; font-size:14px;">
            <option value="3">éå¸¸ã«æ»‘ã‚Šã‚„ã™ã„</option>
            <option value="2">æ»‘ã‚Šã‚„ã™ã„</option>
            <option value="1">ã‚ã¾ã‚Šæ»‘ã‚‰ãªã„</option>
        </select>
        <p style="font-size:12px; margin-bottom:5px; font-weight:bold;">çŠ¶æ³ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚ï¼ˆä»»æ„ï¼‰</p>
        <textarea id="road-comment" maxlength="60" placeholder="60æ–‡å­—ä»¥å†…" style="width:100%; padding:10px; margin-bottom:15px; border-radius:8px; border:1px solid #ddd; height:60px; box-sizing: border-box; font-size:14px; resize:none;"></textarea>
        <button onclick="submitRoadReport()" style="background:#1e88e5; color:white; border:none; padding:14px; border-radius:8px; width:100%; font-weight:bold; cursor:pointer; font-size:15px;">æŠ•ç¨¿ã™ã‚‹</button>
        <button onclick="closeRoadReport()" style="background:none; color:#999; border:none; width:100%; margin-top:10px; cursor:pointer; font-size:12px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
</div>

<div id="rule-modal">
    <div class="rule-content">
        <div class="close-rule-btn" onclick="closeRule()">âœ•</div>
        <h3 style="margin-top: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;">ã™ãªã‚µãƒ åˆ©ç”¨ã®ãƒ«ãƒ¼ãƒ« - è·¯é¢çŠ¶æ³ã®æŠ•ç¨¿</h3>
        <p>ã€Œè·¯é¢çŠ¶æ³ã®æŠ•ç¨¿ã€ã¯ã€ã™ãªã‚µãƒã‚’åˆ©ç”¨ã™ã‚‹ã¿ãªã•ã‚“ãŒã€ä»Šã„ã‚‹å ´æ‰€ã®æ»‘ã‚Šå…·åˆã‚„å†¬é“ã®çŠ¶æ³ã‚’è‡ªç”±ã«å…±æœ‰ã—ã€æœ­å¹Œã®å†¬ã‚’å®‰å…¨ã«æ­©ããŸã‚ã®å ´ã§ã™ã€‚</p>
        <p>é–‹ç™ºè€…ã§ã¯ã€å¤šãã®æ–¹ã€…ãŒå¿«é©ã«åˆ©ç”¨ã§ãã‚‹ç’°å¢ƒã‚’æä¾›ã™ã‚‹ãŸã‚ã«ã€æ˜ã‚‰ã‹ã«æ‚ªæ„ã®ã‚ã‚‹è¡Œç‚ºã‚„ä¸æ­£åˆ©ç”¨ã€ä¸é©åˆ‡ãªæŠ•ç¨¿ã«ã¯å³ã—ãå¯¾å‡¦ã‚’è¡Œã£ã¦ãŠã‚Šã¾ã™ã€‚</p>
        
        <b class="rule-section-title">ãŠå®¢æ§˜ã‹ã‚‰æŠ•ç¨¿ã„ãŸã ã„ãŸæƒ…å ±ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</b>
        <p>ãƒ»<b>æƒ…å ±ã®å…¬é–‹</b>: æŠ•ç¨¿ã•ã‚ŒãŸä½ç½®æƒ…å ±ã€æ»‘ã‚Šå…·åˆã®ãƒ¬ãƒ™ãƒ«ã€ã‚³ãƒ¡ãƒ³ãƒˆã¯ã€ã™ã¹ã¦ã®åˆ©ç”¨è€…ã«å…¬é–‹ã•ã‚Œã¾ã™ã€‚<br>
        ãƒ»<b>ä¿å­˜æœŸé–“</b>: æŠ•ç¨¿ã¯ä¸€å®šæ™‚é–“ï¼ˆ6æ™‚é–“ï¼‰çµŒéã™ã‚‹ã¨åœ°å›³ä¸Šã‹ã‚‰è‡ªå‹•çš„ã«æ¶ˆå»ã•ã‚Œã¾ã™ã€‚<br>
        ãƒ»<b>å‰Šé™¤æ¨©é™</b>: é–‹ç™ºè€…ãŒä¸é©åˆ‡ã¨åˆ¤æ–­ã—ãŸæŠ•ç¨¿ã«ã¤ã„ã¦ã¯ã€è‡ªå‹•æ¶ˆæ»…ã‚’å¾…ãŸãšæ‰‹å‹•ã§å‰Šé™¤ã‚’è¡Œã†å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
        ãƒ»<b>ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã®è¨˜éŒ²</b>: ä¸æ­£åˆ©ç”¨é˜²æ­¢ãŠã‚ˆã³å®‰å…¨æ€§ç¢ºä¿ã®ãŸã‚ã€æŠ•ç¨¿æ™‚ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ä¸€å®šæœŸé–“ä¿æŒã—ã¦ã„ã¾ã™ã€‚</p>

        <b class="rule-section-title">æŠ•ç¨¿ã«ã‚ãŸã£ã¦ã®æ³¨æ„äº‹é …</b>
        <p>æŠ•ç¨¿ã™ã‚‹éš›ã«ã¯ã€æ¬¡ã®å†…å®¹ãŒå«ã¾ã‚Œã‚‹æŠ•ç¨¿ã‚’ç¦æ­¢ã—ã¦ã„ã¾ã™ã€‚ãƒ«ãƒ¼ãƒ«ã‚’éµå®ˆã—ãŸä¸Šã§ã®ã”åˆ©ç”¨ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚</p>

        <p><b>â– ä»–äººã‚’ä¸å¿«ã«ã•ã›ã‚‹æŠ•ç¨¿ã€èª¹è¬—ä¸­å‚·</b><br>
        ãƒ»ç‰¹å®šã®å€‹äººã‚„å›£ä½“ã‚’æ”»æ’ƒã—ãŸã‚Šã€ä¸å¿«æ„Ÿãƒ»å«Œæ‚ªæ„Ÿã‚’ç”Ÿã˜ã•ã›ã‚‹è¡¨ç¾ï¼ˆæš´è¨€ã€ã„ã‚„ãŒã‚‰ã›ã€ç…½ã‚Šãªã©ï¼‰ã¯ç¦æ­¢ã§ã™ã€‚</p>

        <p><b>â– å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ã®æŠ•ç¨¿</b><br>
        ãƒ»è‡ªåˆ†ã‚„ä»–äººã‚’å•ã‚ãšã€åå‰ã€ä½æ‰€ã€é›»è©±ç•ªå·ã€SNSã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDãªã©ã®å€‹äººæƒ…å ±ã®å…¬é–‹ã¯ã€ä¸æ³•è¡Œç‚ºã«è©²å½“ã™ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>

        <p><b>â– å½æƒ…å ±ãƒ»èª¤æƒ…å ±ã®æŠ•ç¨¿</b><br>
        ãƒ»å®Ÿéš›ã¨ã¯ç•°ãªã‚‹æ»‘ã‚Šå…·åˆã‚’æ„å›³çš„ã«æŠ•ç¨¿ã™ã‚‹ãªã©ã€ä»–è€…ã®å®‰å…¨ã‚’è„…ã‹ã™æã‚Œã®ã‚ã‚‹è™šå½ã®æƒ…å ±ã®æŠ•ç¨¿ã¯ç¦æ­¢ã§ã™ã€‚</p>

        <p><b>â– çŠ¯ç½ªè¡Œç‚ºã®äºˆå‘Šã€æ³•ä»¤é•å</b><br>
        ãƒ»æ³•ä»¤é•åã‚„çŠ¯ç½ªè¡Œç‚ºã‚’èª˜ç™ºãƒ»åŠ©é•·ã™ã‚‹å†…å®¹ã€ã„ãŸãšã‚‰ã®æŠ•ç¨¿ã¯ç¦æ­¢ã§ã™ã€‚</p>

        <p><b>â– ãã®ä»–ã€ä¸é©åˆ‡ã¨åˆ¤æ–­ã•ã‚Œã‚‹è¡Œç‚º</b><br>
        ãƒ»å•†æ¥­ç›®çš„ã®å®£ä¼ã€åºƒå‘Šè¡Œç‚ºã€å‡ºä¼šã„ã‚’ç›®çš„ã¨ã™ã‚‹æŠ•ç¨¿ã€‚<br>
        ãƒ»æ„å‘³ã‚’ãªã•ãªã„æ–‡å­—ã‚„è¨˜å·ã®ç¾…åˆ—ãªã©ã®è’ã‚‰ã—è¡Œç‚ºã€‚<br>
        ãƒ»å…¬åºè‰¯ä¿—ã«åã™ã‚‹ã‚ã„ã›ã¤ãƒ»æš´åŠ›çš„ãªè¡¨ç¾ã€‚</p>

        <b class="rule-section-title">é•åã¨åˆ¤æ–­ã—ãŸå ´åˆã®å¯¾å‡¦ã«ã¤ã„ã¦</b>
        <p>é–‹ç™ºè€…ãŒåˆ©ç”¨ãƒ«ãƒ¼ãƒ«ã«é•åã—ã¦ã„ã‚‹ã€ã¾ãŸã¯ä¸é©åˆ‡ã§ã‚ã‚‹ã¨åˆ¤æ–­ã—ãŸå ´åˆã¯ã€æŠ•ç¨¿ã®å‰Šé™¤ã‚’è¡Œã„ã¾ã™ã€‚<br>
        ã¾ãŸã€çŠ¯ç½ªäºˆå‘Šã‚„åèª‰æ¯€æã€æ¥­å‹™å¦¨å®³ç½ªãªã©ã«è©²å½“ã™ã‚‹æ‚ªè³ªãªæŠ•ç¨¿ãŒãªã•ã‚ŒãŸå ´åˆã€è¨˜éŒ²ã—ã¦ã„ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã«åŸºã¥ãã€è­¦å¯Ÿã¸ã®é€šå ±ã‚„æƒ…å ±é–‹ç¤ºã‚’è¡Œã†å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
    </div>
</div>

<div id="layer-modal" onclick="closeLayer()"><div class="layer-panel" onclick="event.stopPropagation()"><div class="layer-title">è¡¨ç¤ºãƒ¬ã‚¤ãƒ¤ãƒ¼</div><div id="layer-shelter" class="layer-item" onclick="toggleLayer('shelter')"><div class="layer-icon-box" style="background-image: url('https://raw.githubusercontent.com/sapporo-geolab/hinanzyo-img/main/hinanzyo.png');"></div><div class="layer-label">é¿é›£æ‰€</div></div></div></div>
<div id="info-modal">
    <div class="modal-content info-content">
        <button class="close-btn-round" onclick="closeInfo()">âœ•</button>
        <h3 style="margin-top:0;">ã™ãªã‚µãƒ ã«ã¤ã„ã¦</h3>
        <p>ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ <a href="https://github.com/sapporo-geolab" target="_blank">å²¡æœ¬ å“ä¹Ÿ</a> ã«ã‚ˆã‚Šä½œæˆã•ã‚Œã¾ã—ãŸã€‚</p>
        <p>æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆ©ç”¨ã™ã‚‹ç ‚ç®±ãŠã‚ˆã³é¿é›£æ‰€ã®ä½ç½®æƒ…å ±ãƒ‡ãƒ¼ã‚¿ã¯ã€æœ­å¹Œå¸‚ICTæ´»ç”¨ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã€Œ<a href="https://data.pf-sapporo.jp/" target="_blank">DATA-SMART CITY SAPPORO</a>ã€ã«ãŠã„ã¦å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚</p>
        <p style="margin-top:15px; font-weight:bold;">ğŸ’¡ ã¤ã‹ã„ã‹ãŸ</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>ç ‚ã‚’ã¾ã</b>: åœ°å›³ä¸Šã®ç ‚ç®±ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œç ‚ã‚’ã¾ãã¾ã—ãŸï¼ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€è¶³å…ƒã«æ˜ŸãŒç©ã‚‚ã‚Šã¾ã™ã€‚</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>ç ‚åˆ‡ã‚Œã‚’æ•™ãˆã‚‹</b>: åœ°å›³ä¸Šã®ç ‚ç®±ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>çŠ¶æ³ã‚’ç¢ºèªã™ã‚‹</b>: å³ä¸Šã®ç ‚ç®±ã‚¢ã‚¤ã‚³ãƒ³ã‚’æŠ¼ã™ã¨ã€ç¾åœ¨å ±å‘Šã•ã‚Œã¦ã„ã‚‹ç ‚åˆ‡ã‚Œãƒªã‚¹ãƒˆã‚’ç¢ºèªã§ãã¾ã™ã€‚</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’é¸ã¶</b>: å³å´ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‹ã‚‰é¿é›£æ‰€ãªã©ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>ç¾åœ¨åœ°ã¸è¡Œã</b>: å³å´ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ã‚¯ã‚’æŠ¼ã™ã¨ã€ã‚ãªãŸã®ä»Šã„ã‚‹å ´æ‰€ã¸ã‚¸ãƒ£ãƒ³ãƒ—ã—ã¾ã™ã€‚</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>è·¯é¢çŠ¶æ³ã‚’æŠ•ç¨¿ã™ã‚‹</b>: å·¦ä¸‹ã®ã€ŒæŠ•ç¨¿ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ã€ç¾åœ¨ã®æ»‘ã‚Šå…·åˆã‚’ã¿ã‚“ãªã«å…±æœ‰ã§ãã¾ã™ã€‚</p>
        <p style="margin-left:5px; margin-bottom:4px;">ãƒ»<b>ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ã‚’è¦‹ã‚‹</b>: åœ°å›³ä¸Šã®ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ç¾åœ¨ã®è¡—ã®æ§˜å­ã‚’æ˜ åƒã§ç¢ºèªã§ãã¾ã™ã€‚</p>
        <p style="margin-top:15px;">ç ‚ç®±ãƒ‡ãƒ¼ã‚¿ã¯å¹³æˆ30å¹´æ™‚ç‚¹ã®ã‚‚ã®ã§ã‚ã‚Šã€ç¾åœ°ã®çŠ¶æ³ã¨å¿…ãšã—ã‚‚ä¸€è‡´ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚</p>
        <p>æœ¬ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºå†…å®¹ã‚„ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã€æœ­å¹Œå¸‚ãŠã‚ˆã³é–¢é€£äº‹æ¥­è€…ã¸ã®ç›´æ¥ã®å•ã„åˆã‚ã›ã¯è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚</p>
        <p>ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ <a href="https://github.com/sapporo-geolab" target="_blank">GitHub ãƒªãƒã‚¸ãƒˆãƒª</a> ã«ã¦å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
        <p style="font-size: 11px; color: #888; text-align: center; margin-top: 15px;">Â©2026 Takuya Okamoto</p>
    </div>
</div>
<canvas id="snow-canvas"></canvas>
<div class="info-panel"><div id="date-display">----å¹´--æœˆ--æ—¥(-)</div><div id="time-display">00:00:00</div></div>
<div class="mt-controls">
    <button class="mt-btn log-toggle-btn" onclick="openLog()"></button>
    <button class="mt-btn" onclick="openLayer()"><svg viewBox="0 0 24 24" width="28" height="28" fill="#333"><path d="M11.99 18.54l-7.37-5.73L3 14.07l9 7 9-7-1.63-1.27-7.38 5.74zM12 16l7.36-5.73L21 9l-9-7-9 7 1.63 1.27L12 16z"/></svg></button>
    <button class="mt-btn" onclick="jumpToCurrentLocation()"><svg viewBox="0 0 24 24" width="24" height="24" fill="#333"><path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06z"/></svg></button>
    <button class="mt-btn" onclick="map.zoomIn()"><svg viewBox="0 0 24 24" width="24" height="24" fill="#333"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg></button>
    <button class="mt-btn" onclick="map.zoomOut()"><svg viewBox="0 0 24 24" width="24" height="24" fill="#333"><path d="M19 13H5v-2h14v2z"/></svg></button>
    <button class="mt-btn" onclick="openInfo()"><svg viewBox="0 0 24 24" width="26" height="26" fill="#333"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg></button>
</div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyBwFxgKbcxT-PrH2lezAtqAQ5DNVX7Fk4o",
      authDomain: "suna-sapo-3d.firebaseapp.com",
      projectId: "suna-sapo-3d",
      storageBucket: "suna-sapo-3d.firebasestorage.app",
      messagingSenderId: "618496872034",
      appId: "1:618496872034:web:050fef3a74fa2af0b88b3b",
      databaseURL: "https://suna-sapo-3d-default-rtdb.firebaseio.com" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let rawData = [];
    let reportLog = [];
    let sandboxData = { type: 'FeatureCollection', features: [] };
    let shelterMarkers = [];
    let roadMarkers = [];
    let sheltersVisible = false;
    let isTracking = false; 
    let initialGPSLocked = false;
    let lastCoords = null;
    let activeStars = []; const SIX_HOURS_MS = 6 * 60 * 60 * 1000;
    
    // é›ªã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆåˆ¶å¾¡ãƒ•ãƒ©ã‚°
    let isSnowEnabled = true;

    // ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ç”¨å¤‰æ•°ã®è¿½åŠ 
    let hoverPopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false, className: 'hover-video-popup', offset: 15, anchor: 'bottom' });
    const cameraCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/3d64bf54acce4d6095738dc1383cfb57/raw/523aa4f7a043b8e436a03e37f472336c3934b562/livecamera.csv';

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rbm4yOXE5MDdwNDNkczh5MnlqNnI4eCJ9.Utenu-9vEz56uGUETeWS1g';
    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/standard', center: [141.3508, 43.0645], zoom: 17, pitch: 65, bearing: -10, attributionControl: false });

    const userMarkerEl = document.createElement('div');
    userMarkerEl.style.width = '20px'; userMarkerEl.style.height = '20px';
    userMarkerEl.style.background = '#007cff'; userMarkerEl.style.border = '3px solid white';
    userMarkerEl.style.borderRadius = '50%'; userMarkerEl.style.boxShadow = '0 0 15px rgba(0,124,255,0.8)';
    const userMarker = new mapboxgl.Marker(userMarkerEl).setLngLat([0, 0]).addTo(map);

    function handleOrientation(event) { if (!isTracking) return; let heading = event.webkitCompassHeading || (360 - event.alpha); if (heading) map.setBearing(heading); }
    navigator.geolocation.watchPosition((pos) => {
        const lng = pos.coords.longitude;
        const lat = pos.coords.latitude;
        const accuracy = pos.coords.accuracy;
        lastCoords = [lng, lat];
        userMarker.setLngLat(lastCoords);
        if (!initialGPSLocked && accuracy < 80) { initialGPSLocked = true; document.getElementById('status-text').textContent = "ç¾åœ¨åœ°ã‚’å–å¾—ï¼"; map.jumpTo({ center: lastCoords }); }
        if (isTracking) map.setCenter(lastCoords);
    }, (err) => { initialGPSLocked = true; }, { enableHighAccuracy: true });

    function jumpToCurrentLocation() {
        if (!lastCoords) return;
        isTracking = true;
        window.addEventListener('deviceorientation', handleOrientation);
        map.flyTo({ center: lastCoords, zoom: 18.5, pitch: 70, speed: 1.5 });
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') { DeviceOrientationEvent.requestPermission().catch(console.error); }
    }

    map.on('dragstart', () => { isTracking = false; window.removeEventListener('deviceorientation', handleOrientation); });
    function openLog() { document.getElementById('log-modal').style.display = 'flex'; }
    function closeLog() { document.getElementById('log-modal').style.display = 'none'; }
    function openInfo() { document.getElementById('info-modal').style.display = 'flex'; }
    function closeInfo() { document.getElementById('info-modal').style.display = 'none'; }
    function openLayer() { document.getElementById('layer-modal').style.display = 'flex'; }
    function closeLayer() { document.getElementById('layer-modal').style.display = 'none'; }
    function toggleLayer(type) {
        if (type === 'shelter') {
            sheltersVisible = !sheltersVisible;
            shelterMarkers.forEach(m => sheltersVisible ? m.addTo(map) : m.remove());
            document.getElementById('layer-shelter').classList.toggle('active', sheltersVisible);
        }
    }

    function openRule() { document.getElementById('rule-modal').style.display = 'flex'; }
    function closeRule() { document.getElementById('rule-modal').style.display = 'none'; }

    function openRoadReport() {
        if (!lastCoords) { alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"); return; }
        const lon = lastCoords[0]; const lat = lastCoords[1];
        if (lon < 141.0 || lon > 141.6 || lat < 42.8 || lat > 43.2) {
            alert("æœ­å¹Œå¸‚å†…ã®ã¿æŠ•ç¨¿å¯èƒ½ã§ã™ã€‚"); return;
        }
        document.getElementById('road-modal').style.display = 'flex';
    }
    function closeRoadReport() { document.getElementById('road-modal').style.display = 'none'; }
    function submitRoadReport() {
        const level = document.getElementById('road-level').value;
        const comment = document.getElementById('road-comment').value;
        db.ref('road_reports').push({ lat: lastCoords[1], lng: lastCoords[0], level: level, comment: comment, timestamp: Date.now() });
        alert("ã¿ã‚“ãªã«å½¹ç«‹ã¤æƒ…å ±ã‚’ã‚ã‚ŠãŒã¨ã†ï¼");
        closeRoadReport();
        document.getElementById('road-comment').value = "";
    }

    window.spreadSand = function(id) {
        const s = rawData[id]; const now = Date.now();
        const originLng = parseFloat(s['çµŒåº¦ï¼ˆåº¦ï¼‰']), originLat = parseFloat(s['ç·¯åº¦ï¼ˆåº¦ï¼‰']);
        for (let i = 0; i < 24; i++) {
            const vx = (Math.random() - 0.5) * 0.00004;
            const vy = (Math.random() - 0.5) * 0.00004;
            const targetLng = originLng + (Math.random() - 0.5) * 0.00045;
            const targetLat = originLat + (Math.random() - 0.5) * 0.00045;
            db.ref('stars').push({ originLng, originLat, targetLng, targetLat, vx, vy, createdAt: now });
        }
        alert("ç ‚ã‚’ã¾ã„ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã‚ãªãŸã«ç´ æ•µãªã“ã¨ãŒã‚ã‚Šã¾ã™ã‚ˆã†ã«");
        const popup = document.querySelector('.mapboxgl-popup'); if (popup) popup.remove();
    };

    const canvas = document.getElementById('snow-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();
    function updateSnow() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if (!isSnowEnabled) { requestAnimationFrame(updateSnow); return; } // å‹•ç”»è¡¨ç¤ºä¸­ã¯æç”»ã—ãªã„
        const pitch = map.getPitch(); 
        const is3D = pitch > 25;
        if (particles.length < 160) {
            particles.push({ x: Math.random() * canvas.width, y: Math.random() * canvas.height, r: Math.random() * 2.5 + 0.5, o: Math.random() * 0.4 + 0.2, vx: (Math.random() - 0.5) * 0.8, vy: Math.random() * 1.2 + 0.8 });
        }
        for (let i = 0; i < particles.length; i++) {
            let p = particles[i];
            let fadeOut = 1;
            if (p.y > canvas.height * 0.8) fadeOut = 1 - (p.y - canvas.height * 0.8) / (canvas.height * 0.2);
            ctx.beginPath();
            ctx.fillStyle = `rgba(255, 255, 255, ${p.o * fadeOut})`;
            if (!is3D) {
                const scale = 1 - (p.y / canvas.height) * 0.5;
                ctx.arc(p.x, p.y, p.r * scale, 0, Math.PI * 2);
                p.y += p.vy;
            } else {
                const perspective = (p.y / canvas.height);
                const speed = p.vy * (1 + perspective * 1.2);
                const xShift = (p.x - canvas.width / 2) * (perspective * 0.06);
                let displayRadius = Math.min(p.r * (1 + perspective * 1.5), 4);
                ctx.arc(p.x + xShift, p.y, displayRadius, 0, Math.PI * 2);
                p.y += speed; p.x += p.vx + xShift * 0.01;
            }
            if (p.y > canvas.height || p.x < -50 || p.x > canvas.width + 50 || fadeOut <= 0) { p.y = -20; p.x = Math.random() * canvas.width; }
            ctx.fill();
        }
        requestAnimationFrame(updateSnow);
    }

    function animateStarsLoop() {
        const now = Date.now();
        activeStars = activeStars.filter(s => (now - s.createdAt) < SIX_HOURS_MS);
        activeStars.forEach(s => {
            if (!s.isLanded) {
                const elapsed = now - s.createdAt;
                if (elapsed > 1500) {
                    s.isLanded = true;
                    s.lon = s.targetLng;
                    s.lat = s.targetLat;
                } else {
                    const progress = elapsed / 1500;
                    s.lon = s.originLng + (s.targetLng - s.originLng) * progress;
                    s.lat = s.originLat + (s.targetLat - s.originLat) * progress;
                }
            } else {
                s.lon = s.targetLng;
                s.lat = s.targetLat;
            }
        });
        if (map.getSource('stars-source')) {
            map.getSource('stars-source').setData({ type: 'FeatureCollection', features: activeStars.map(s => ({ type: 'Feature', geometry: { type: 'Point', coordinates: [s.lon, s.lat] } })) });
        }
        requestAnimationFrame(animateStarsLoop);
    }
    
    function applyGlowingEffect() {
        if (!map.isStyleLoaded()) return;
        const now = new Date();
        const hour = now.getHours();
        const min = now.getMinutes();
        const currentTime = hour + min / 60;
        let preset = (currentTime >= 6 && currentTime < 15) ? 'day' : (currentTime >= 15 && currentTime < 16.5) ? 'dusk' : 'night';
        map.setConfigProperty('basemap', 'lightPreset', preset);
        map.setConfigProperty('basemap', 'showPointOfInterestLabels', false);
        if (map.getLayer('sunabako-layer')) {
            map.setPaintProperty('sunabako-layer', 'fill-extrusion-emissive-strength', (preset === 'dusk' || preset === 'night') ? 0.8 : 0);
        }
    }
    
    function hideLoader() {
        const checkGPS = setInterval(() => {
            if (initialGPSLocked) { clearInterval(checkGPS); setTimeout(() => { document.getElementById('loader').style.opacity = '0'; setTimeout(() => { document.getElementById('loader').style.visibility = 'hidden'; }, 1200); }, 800); }
        }, 500);
    }

    async function loadAndRunGraphics() {
        const gistUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ef76bf0034584f3c6ee30d7489f7f427/raw/graphics.js?t=' + Date.now();
        try {
            const response = await fetch(gistUrl);
            const scriptContent = await response.text();
            const drawFunc = new Function('map', 'rawData', 'sandboxData', scriptContent + '\nupdateSandboxGraphics(map, rawData, sandboxData);');
            drawFunc(map, rawData, sandboxData);
            if (map.getSource('sunabako-source')) { map.getSource('sunabako-source').setData(sandboxData); }
            applyGlowingEffect();
            hideLoader();
        } catch (e) { console.error(e); hideLoader(); }
    }

    map.on('load', () => {
        const starCanvas = document.createElement('canvas'); starCanvas.width = 64; starCanvas.height = 64;const starCtx = starCanvas.getContext('2d'); starCtx.font = '48px serif'; starCtx.textAlign = 'center'; starCtx.textBaseline = 'middle';
        starCtx.fillText('â­', 32, 32); map.addImage('star-icon', starCtx.getImageData(0, 0, 64, 64));

        map.addSource('stars-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        map.addLayer({
            id: 'stars-layer', type: 'symbol', source: 'stars-source', slot: 'top',
            layout: { 
                'icon-image': 'star-icon', 
                'icon-size': ['interpolate', ['linear'], ['zoom'], 14, 0.05, 18, 0.24], 
                'icon-allow-overlap': true, 
                'icon-ignore-placement': true 
            },
            paint: { 'icon-emissive-strength': 1.0 }
        });

        db.ref('stars').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const now = Date.now();
            activeStars = [];
            Object.keys(data).forEach(key => {
                const s = data[key];
                if (now - s.createdAt < SIX_HOURS_MS) {
                    const elapsed = now - s.createdAt;
                    const isLanded = elapsed > 1500; 
                    activeStars.push({
                        id: key, 
                        lon: isLanded ? s.targetLng : s.originLng, 
                        lat: isLanded ? s.targetLat : s.originLat,
                        originLng: s.originLng, originLat: s.originLat,
                        targetLng: s.targetLng, targetLat: s.targetLat,
                        vx: s.vx, vy: s.vy, createdAt: s.createdAt, isLanded: isLanded
                    });
                }
            });
        });

       
        map.on('mouseenter', 'camera-layer', (e) => {
            map.getCanvas().style.cursor = 'pointer';
            const coords = e.features[0].geometry.coordinates.slice();
            const { title, videoId } = e.features[0].properties;
            const thumbUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
            hoverPopup.setLngLat(coords).setHTML(`
                <div class="hover-video-title">${title}</div>
                <div style="width:180px; aspect-ratio:16/9; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                    <img src="${thumbUrl}" style="width:100%; height:100%; object-fit:cover;">
                </div>`).addTo(map);
        });
        map.on('mouseleave', 'camera-layer', () => { map.getCanvas().style.cursor = ''; hoverPopup.remove(); });

        map.on('click', 'camera-layer', (e) => {
            // è¿½åŠ ï¼šã“ã‚Œã‚ˆã‚Šä¸‹ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç ‚ç®±ãªã©ï¼‰ã«ã‚¯ãƒªãƒƒã‚¯ã‚’ä¼æ’­ã•ã›ãªã„
    if (e.features.length > 0) {
        e.originalEvent.cancelBubble = true; 
    }
            const f = e.features[0];
            const { title, videoId } = f.properties;
            const coords = f.geometry.coordinates.slice();
            map.flyTo({ center: coords, zoom: 17.5, pitch: 60, offset: [0, -100] });
            
            // å°ç”»é¢ã‚’å¼·åˆ¶è¡¨ç¤º
            const thumbUrl = `https://img.youtube.com/vi/${videoId}/mqdefault.jpg`;
            hoverPopup.setLngLat(coords).setHTML(`
                <div class="hover-video-title">${title}</div>
                <div style="width:180px; aspect-ratio:16/9; background:#000; display:flex; align-items:center; justify-content:center; overflow:hidden;">
                    <img src="${thumbUrl}" style="width:100%; height:100%; object-fit:cover;">
                </div>`).addTo(map);

            // é›ªã‚’ã‚ªãƒ•ã«ã™ã‚‹
            isSnowEnabled = false;

            const mainPopup = new mapboxgl.Popup({ className: 'live-camera-main-popup', anchor: 'bottom' })
                .setLngLat(coords)
                .setHTML(`
                    <div class="popup-header-cam">ğŸ¥ ${title}</div>
                    <div style="width:100%; aspect-ratio:16/9; background:#000;">
                        <iframe width="100%" height="100%" src="https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>`)
                .addTo(map);

            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’é–‰ã˜ãŸã‚‰é›ªã‚’å†é–‹
            mainPopup.on('close', () => { isSnowEnabled = true; });
        });

       const csvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ca0f9f45e8a5e2064678f14eb8e7e933/raw/33abeeab3374bc93c97d208c90056b7355c04802/h301.csv';
        Papa.parse(csvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: async function(results) {
                rawData = results.data;
                db.ref('reports').on('value', (snapshot) => {
                    const reports = snapshot.val() || {};
                    rawData.forEach((item, idx) => { item.isGray = !!reports[idx]; });
                    reportLog = Object.keys(reports).map(id => ({ id: id, address: rawData[id]['ä½æ‰€'], time: reports[id].timeLabel })).reverse();
                    updateLogPanel(); 
                    loadAndRunGraphics(); 
                    animateStarsLoop();
                });
                db.ref('road_reports').on('value', (snapshot) => {
                    const data = snapshot.val() || {}; roadMarkers.forEach(m => m.remove()); roadMarkers = [];
                    Object.values(data).forEach(report => {
                        if (Date.now() - report.timestamp < 21600000) {
                            let iconUrl = "https://raw.githubusercontent.com/sapporo-geolab/suna-sapo-3d/main/level" + report.level + ".jpg";
                            const el = document.createElement('div'); el.className = 'road-icon' + (report.comment ? ' road-icon-comment' : '');
                            el.style.backgroundImage = `url('${iconUrl}')`;
                            const marker = new mapboxgl.Marker(el).setLngLat([report.lng, report.lat]);
                            if (report.comment) marker.setPopup(new mapboxgl.Popup({offset:15}).setHTML(`<div style="color:#333;font-size:12px;padding:5px;">${report.comment}</div>`));
                            marker.addTo(map); roadMarkers.push(marker);
                        }
                    });
                });
                map.addSource('sunabako-source', { 'type': 'geojson', 'data': sandboxData });
                map.addLayer({ 'id': 'sunabako-click-area', 'type': 'circle', 'source': 'sunabako-source', 'slot': 'top', 'paint': { 'circle-radius': 15, 'circle-color': 'rgba(0,0,0,0)', 'circle-stroke-width': 0 } });
                map.addLayer({ 'id': 'sunabako-layer', 'type': 'fill-extrusion', 'source': 'sunabako-source', 'slot': 'top', 'paint': { 'fill-extrusion-color': ['get', 'color'], 'fill-extrusion-height': ['coalesce', ['get', 'height'], 0], 'fill-extrusion-base': ['coalesce', ['get', 'base'], 0], 'fill-extrusion-vertical-gradient': true } });
                updateSnow(); loadShelters();
            } // â† ã“ã“ã§ async function ã®ç®±ã‚’é–‰ã˜ã‚‹
        }); // â† ã“ã“ã§æœ€åˆã® Papa.parse ã®ç®±ã‚’é–‰ã˜ã‚‹

        // --- ãƒ©ã‚¤ãƒ–ã‚«ãƒ¡ãƒ©ã®å®Ÿè£… ---
        const camSvg = `<svg width="64" height="64" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><circle cx="32" cy="32" r="30" fill="white" stroke="#333" stroke-width="3"/><path d="M18 22h20a2 2 0 0 1 2 2v16a2 2 0 0 1-2 2H18a2 2 0 0 1-2-2V24a2 2 0 0 1 2-2zm24 6l8-4v16l-8-4v-8z" fill="#333"/></svg>`;
        const camImg = new Image();
        camImg.onload = () => map.addImage('camera-custom', camImg);
        camImg.src = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(camSvg);

        Papa.parse(cameraCsvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => {
                const camFeatures = results.data.map(row => {
                    const title = row['ã‚¿ã‚¤ãƒˆãƒ«'] || row['No'] || "ä¸æ˜";
                    const latLngStr = row['ç·¯åº¦çµŒåº¦'] || "";
                    const parts = latLngStr.split(',').map(s => parseFloat(s.trim()));
                    const vUrl = row['URL'] || "";
                    let vId = vUrl.includes('v=') ? vUrl.split('v=')[1].split('&')[0] : (vUrl.includes('youtu.be/') ? vUrl.split('youtu.be/')[1].split('?')[0] : "");
                    if (parts.length === 2 && !isNaN(parts[0])) {
                        return { 'type': 'Feature', 'properties': { 'title': title, 'videoId': vId }, 'geometry': { 'type': 'Point', 'coordinates': [parts[1], parts[0]] } };
                    }
                    return null;
                }).filter(f => f !== null);
                map.addSource('live-cameras', { 'type': 'geojson', 'data': { 'type': 'FeatureCollection', 'features': camFeatures } });
                map.addLayer({ 'id': 'camera-layer', 'type': 'symbol', 'source': 'live-cameras', 'slot': 'top', 'layout': { 'icon-image': 'camera-custom', 'icon-size': 0.6, 'icon-allow-overlap': true } });
            }
        });

        // æ™‚è¨ˆã¯ map.on('load') ã®ä¸­ã‹ã¤ã€ä»–ã® Papa.parse ã®å¤–ã«é…ç½®
        setInterval(() => {
            document.getElementById('date-display').textContent = `${new Date().getFullYear()}å¹´${new Date().getMonth()+1}æœˆ${new Date().getDate()}æ—¥`;
            document.getElementById('time-display').textContent = new Date().toLocaleTimeString('ja-JP', {hour12:false});
            applyGlowingEffect();
        }, 1000);
    }); // ã“ã“ã§ map.on('load') ã‚’é–‰ã˜ã‚‹

    map.on('zoomend', loadAndRunGraphics);
        
    function loadShelters() {
        const shelterCsvUrl = 'https://gist.githubusercontent.com/sapporo-geolab/439bfe19b1a67005f9ca196dc8de7749/raw/55a5b8e97eab134fae8d880d05daa40c916971b4/shelters.csv';
        Papa.parse(shelterCsvUrl, { download: true, header: true, skipEmptyLines: true, complete: function(results) {
            results.data.forEach(row => {
                const lon = parseFloat(row['çµŒåº¦']); const lat = parseFloat(row['ç·¯åº¦']);
                if (!isNaN(lon) && !isNaN(lat)) {
                    const container = document.createElement('div'); container.className = 'shelter-beam-container';
                    const beam = document.createElement('div'); beam.className = 'shelter-beam';
                    const iconMark = document.createElement('div'); iconMark.className = 'shelter-logo-icon'; iconMark.style.backgroundImage = `url('https://raw.githubusercontent.com/sapporo-geolab/hinanzyo-img/main/hinanzyo.png')`;
                    container.appendChild(beam); container.appendChild(iconMark);
                    const marker = new mapboxgl.Marker(container).setLngLat([lon, lat]).setPopup(new mapboxgl.Popup().setHTML(`<div style="color:#333; padding:5px; font-family:sans-serif;"><b>${row['æ–½è¨­å'] || row['é¿é›£æ‰€å']}</b></div>`));
                    shelterMarkers.push(marker); if (sheltersVisible) marker.addTo(map);
                }
            });
        }});
    }

    function updateLogPanel() {
        const list = document.getElementById('log-list'); if (reportLog.length === 0) { list.innerHTML = '<div style="text-align:center; color:#999;">ç¾åœ¨ã€å ±å‘Šã¯ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
        list.innerHTML = reportLog.map(log => `<div style="border-bottom:1px solid #eee; padding:12px 0; display:flex; justify-content:space-between; align-items:center;"><div onclick="closeLog(); map.flyTo({center:[${rawData[log.id]['çµŒåº¦ï¼ˆåº¦ï¼‰']}, ${rawData[log.id]['ç·¯åº¦ï¼ˆåº¦ï¼‰']}], zoom:18.5})" style="cursor:pointer;"><div style="color:#ff3b30; font-size:11px;">ç¢ºèªï¼š${log.time}</div><div style="font-weight:bold; font-size:13px;">${log.address.replace('åŒ—æµ·é“æœ­å¹Œå¸‚', '')}</div></div><button onclick="markAsDone(${log.id})" style="background:#4cd964; color:white; border:none; padding:6px 10px; border-radius:6px; font-size:11px; font-weight:bold; cursor:pointer;">è£œå……ã•ã‚Œã¾ã—ãŸï¼</button></div>`).join('');
    }
    window.reportEmpty = function(id) { db.ref('reports/' + id).set({ time: Date.now(), timeLabel: new Date().toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) }); const popup = document.querySelector('.mapboxgl-popup'); if (popup) popup.remove(); };
    window.markAsDone = function(id) { db.ref('reports/' + id).remove(); const popup = document.querySelector('.mapboxgl-popup'); if (popup) popup.remove(); };
    map.on('click', 'sunabako-click-area', (e) => {
// è¿½åŠ ï¼šã‚‚ã—ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´æ‰€ã«ã‚«ãƒ¡ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®è¦ç´ ã‚‚å«ã¾ã‚Œã¦ã„ãŸã‚‰ã€ç ‚ç®±ã¯é–‹ã‹ãªã„
    const featuresAtPoint = map.queryRenderedFeatures(e.point, { layers: ['camera-layer'] });
    if (featuresAtPoint.length > 0) return;
        
        const p = e.features[0].properties; if (p.id === undefined) return;
        const isGray = rawData[p.id].isGray; const cleanAddr = rawData[p.id]['ä½æ‰€'].replace('åŒ—æµ·é“æœ­å¹Œå¸‚', '');
        new mapboxgl.Popup({ maxWidth: '280px', focusAfterOpen: true, anchor: 'center' }).setLngLat(e.lngLat).setHTML(`
            <div style="font-family: sans-serif; width: 220px; color: #333;">
                <img src="https://raw.githubusercontent.com/sapporo-geolab/suna-img/main/suna.jpg" style="width:100%; border-radius:8px;">
                <p style="margin: 10px 0 5px; font-size:14px;"><strong>${cleanAddr}</strong></p>
                ${isGray ? `<div style="color: #ff3b30; font-size: 11px; font-weight: bold; margin-bottom: 5px;">ç¾åœ¨ã€ç ‚åˆ‡ã‚Œå ±å‘ŠãŒå‡ºã¦ã„ã¾ã™</div><button class="pop-btn report-btn-disabled" disabled>ç ‚ã‚’ã¾ãã¾ã—ãŸï¼</button><button class="pop-btn report-btn-disabled" disabled>ç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹</button><button class="pop-btn done-btn-green" onclick="markAsDone(${p.id})">è£œå……ã•ã‚Œã¾ã—ãŸï¼</button>` : `<button class="pop-btn spread-btn-blue" onclick="spreadSand(${p.id})">ç ‚ã‚’ã¾ãã¾ã—ãŸï¼</button><button class="pop-btn report-btn-red" onclick="reportEmpty(${p.id})">ç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹</button>`}
            </div>`).addTo(map);
    });
</script>
</body>
</html>









