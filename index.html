<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <title>Suna-Sapo: Clear 3D Snow</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10001; transition: opacity 1s ease, visibility 1s; }
        #loader-logo-container { width: 240px; height: 240px; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        #loader-logo-img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .dot-pulse { display: flex; align-items: center; justify-content: center; }
        .dot-pulse div { width: 14px; height: 14px; margin: 0 10px; background-color: #00fbff; border-radius: 50%; animation: dot-pulse 1.4s infinite ease-in-out both; }
        @keyframes dot-pulse { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1.2); opacity: 1; } }
        .info-panel { position: absolute; top: 15px; left: 15px; z-index: 1000; color: white; font-family: sans-serif; text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        #time-display { font-size: 24px; font-weight: bold; }
        .mt-controls { position: absolute; top: 15px; right: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .mt-btn { width: 44px; height: 44px; background: white; border: none; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.4); cursor: pointer; display: flex; align-items: center; justify-content: center; background-repeat: no-repeat; background-position: center; }
        .log-toggle-btn { background-image: url('https://raw.githubusercontent.com/sapporo-geolab/sunahako-img/main/sunahako.png'); background-size: 40px; }
        .road-report-btn-yahoo { position: absolute; bottom: 75px; left: 15px; z-index: 1000; background: white; color: #1e88e5; border: none; padding: 10px 20px; border-radius: 24px; font-weight: bold; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: sans-serif; }
        #road-legend { position: absolute; bottom: 145px; left: 15px; z-index: 1000; background: rgba(40, 40, 40, 0.85); padding: 8px 12px; border-radius: 10px; color: white; font-family: sans-serif; font-size: 10px; pointer-events: none; display: flex; flex-direction: column; gap: 4px; }
        .legend-item { display: flex; align-items: center; gap: 6px; }
        .legend-dot { width: 10px; height: 10px; border-radius: 50%; }
        .road-icon { width: 32px; height: 32px; border-radius: 50%; background-size: cover; background-position: center; box-shadow: 0 2px 8px rgba(0,0,0,0.4); cursor: pointer; }
        .road-icon-comment { border: 3px solid white; width: 36px; height: 36px; }
        #log-modal, #info-modal, #road-modal, #layer-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); display: none; justify-content: center; align-items: center; z-index: 20000; backdrop-filter: blur(5px); }
        .modal-content { background: rgba(255, 255, 255, 0.95); width: 340px; border-radius: 15px; overflow-y: auto; font-family: sans-serif; position: relative; }
        .pop-btn { border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 10px; cursor: pointer; font-size: 14px; }
        .spread-btn-blue { background: #007cff !important; color: white !important; }
        .report-btn-red { background: #ff3b30 !important; color: white !important; }
        .report-btn-disabled { background: #cccccc !important; color: #ffffff !important; cursor: not-allowed; }
        .done-btn-green { background: #4cd964; color: white; }
        #snow-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
        .shelter-logo-icon { width: 40px; height: 40px; background-size: contain; background-repeat: no-repeat; }
    </style>
</head>
<body>

<div id="loader">
    <div id="loader-logo-container"><img id="loader-logo-img" src="https://raw.githubusercontent.com/sapporo-geolab/logo-sunahako-img/main/logo_sunasapo.png"></div>
    <div class="dot-pulse"><div></div><div></div><div></div></div>
</div>

<div id="map"></div>

<div id="road-legend">
    <div class="legend-item"><div class="legend-dot" style="background:#ff3b30;"></div>éå¸¸ã«æ»‘ã‚Šã‚„ã™ã„</div>
    <div class="legend-item"><div class="legend-dot" style="background:#ffcc00;"></div>æ»‘ã‚Šã‚„ã™ã„</div>
    <div class="legend-item"><div class="legend-dot" style="background:#007aff;"></div>ã‚ã¾ã‚Šæ»‘ã‚‰ãªã„</div>
    <div class="legend-item" style="margin-top:2px; border-top:1px solid #555; padding-top:2px; opacity:0.8;">â€»ç™½æ ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚ã‚Š</div>
</div>

<button class="road-report-btn-yahoo" onclick="openRoadReport()">ğŸ’¬ æŠ•ç¨¿ã™ã‚‹</button>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyCiSrqwXpRYYYfjkhtLo2lePrN1rjPaPiY",
      authDomain: "suna-sapo-3d.firebaseapp.com",
      projectId: "suna-sapo-3d",
      databaseURL: "https://suna-sapo-3d-default-rtdb.firebaseio.com" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let rawData = [], sandboxData = { type: 'FeatureCollection', features: [] }, roadMarkers = [], lastCoords = null;

    mapboxgl.accessToken = 'pk.eyJ1Ijoic2FwcG9yby1nZW9sYWIiLCJhIjoiY21rbm4yOXE5MDdwNDNkczh5MnlqNnI4eCJ9.Utenu-9vEz56uGUETeWS1g';
    const map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/standard', center: [141.3508, 43.0645], zoom: 17, pitch: 65, attributionControl: false });

    navigator.geolocation.getCurrentPosition(pos => {
        lastCoords = [pos.coords.longitude, pos.coords.latitude];
        map.jumpTo({ center: lastCoords });
    }, null, { enableHighAccuracy: true });

    function hideLoader() {
        const loader = document.getElementById('loader');
        if(loader) { loader.style.opacity = '0'; setTimeout(() => loader.style.visibility = 'hidden', 1000); }
    }

    async function loadGraphics() {
        const gistUrl = 'https://gist.githubusercontent.com/sapporo-geolab/ef76bf0034584f3c6ee30d7489f7f427/raw/graphics.js?t=' + Date.now();
        try {
            const res = await fetch(gistUrl);
            const script = await res.text();
            const drawFunc = new Function('map', 'rawData', 'sandboxData', script + '\nupdateSandboxGraphics(map, rawData, sandboxData);');
            drawFunc(map, rawData, sandboxData);
            if (map.getSource('sunabako-source')) map.getSource('sunabako-source').setData(sandboxData);
        } catch (e) { console.error(e); }
        hideLoader();
    }

    map.on('load', () => {
        // æ˜Ÿãƒ¬ã‚¤ãƒ¤ãƒ¼
        map.addSource('stars-source', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
        map.addLayer({ id: 'stars-layer', type: 'circle', source: 'stars-source', paint: { 'circle-radius': 3.5, 'circle-color': '#FFD700', 'circle-blur': 0.6 } });

        Papa.parse('https://gist.githubusercontent.com/sapporo-geolab/ca0f9f45e8a5e2064678f14eb8e7e933/raw/33abeeab3374bc93c97d208c90056b7355c04802/h301.csv', {
            download: true, header: true, complete: res => {
                rawData = res.data;
                db.ref('reports').on('value', snap => {
                    const reps = snap.val() || {};
                    rawData.forEach((item, i) => item.isGray = !!reps[i]);
                    loadGraphics();
                });
                db.ref('sand_spread').on('value', snap => {
                    const data = snap.val() || {}; const now = Date.now(); const starFeats = [];
                    Object.keys(data).forEach(id => {
                        const valid = Object.values(data[id]).filter(v => now - v.timestamp < 21600000);
                        if (valid.length > 0 && rawData[id]) {
                            for(let i=0; i<Math.min(valid.length, 10); i++) {
                                starFeats.push({ type: 'Feature', geometry: { type: 'Point', coordinates: [parseFloat(rawData[id]['çµŒåº¦ï¼ˆåº¦ï¼‰'])+(Math.random()-0.5)*0.00015, parseFloat(rawData[id]['ç·¯åº¦ï¼ˆåº¦ï¼‰'])+(Math.random()-0.5)*0.00015] } });
                            }
                        }
                    });
                    map.getSource('stars-source').setData({ type: 'FeatureCollection', features: starFeats });
                });
                map.addSource('sunabako-source', { type: 'geojson', data: sandboxData });
                map.addLayer({ id: 'sunabako-click-area', type: 'circle', source: 'sunabako-source', paint: { 'circle-radius': 15, 'circle-color': 'rgba(0,0,0,0)' } });
                map.addLayer({ id: 'sunabako-layer', type: 'fill-extrusion', source: 'sunabako-source', paint: { 'fill-extrusion-color': ['get', 'color'], 'fill-extrusion-height': ['get', 'height'], 'fill-extrusion-base': ['get', 'base'] } });
                hideLoader();
            }
        });
    });

    window.spreadSand = id => {
        db.ref('sand_spread/' + id).push({ timestamp: Date.now() });
        alert("ç ‚ã‚’ã¾ã„ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ã‚ãªãŸã«å¹¸é‹ãŒè¨ªã‚Œã¾ã™ã‚ˆã†ã«");
        const popup = document.querySelector('.mapboxgl-popup'); if (popup) popup.remove();
        window.activeAnimationId = id; setTimeout(() => window.activeAnimationId = null, 3000);
    };

    map.on('click', 'sunabako-click-area', e => {
        const id = e.features[0].properties.id; if (id === undefined) return;
        const isGray = rawData[id].isGray;
        const addr = rawData[id]['ä½æ‰€'].replace('åŒ—æµ·é“æœ­å¹Œå¸‚', '');
        new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(`
            <div style="font-family:sans-serif;width:200px;color:#333;">
                <p><strong>${addr}</strong></p>
                ${isGray ? `
                    <button class="pop-btn report-btn-disabled" disabled>ç ‚ã‚’ã¾ãã¾ã—ãŸï¼</button>
                    <button class="pop-btn done-btn-green" onclick="db.ref('reports/${id}').remove()">è£œå……ã•ã‚Œã¾ã—ãŸï¼</button>
                ` : `
                    <button class="pop-btn spread-btn-blue" onclick="spreadSand(${id})">ç ‚ã‚’ã¾ãã¾ã—ãŸï¼</button>
                    <button class="pop-btn report-btn-red" onclick="db.ref('reports/${id}').set({time:Date.now()})">ç ‚åˆ‡ã‚Œã‚’ã¿ã‚“ãªã«æ•™ãˆã‚‹</button>
                `}
            </div>`).addTo(map);
    });

    // é›ªï¼ˆç°¡æ˜“ç‰ˆã§å®‰å®šåŒ–ï¼‰
    const canvas = document.getElementById('snow-canvas');
    if(canvas) {
        const ctx = canvas.getContext('2d');
        function snow() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            if (window.activeAnimationId !== null && rawData[window.activeAnimationId]) {
                const p = map.project([parseFloat(rawData[window.activeAnimationId]['çµŒåº¦ï¼ˆåº¦ï¼‰']), parseFloat(rawData[window.activeAnimationId]['ç·¯åº¦ï¼ˆåº¦ï¼‰'])]);
                ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(p.x, p.y - 20, 5, 0, Math.PI*2); ctx.fill();
            }
            requestAnimationFrame(snow);
        }
        snow();
    }
</script>
</body>
</html>
